<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
<div class="personas-main-content" style="background:#ffffff; font-family:'Montserrat', sans-serif; overflow-x:hidden;">
  <style>
    /* Compatibilidad: ajustes responsivos y compactos */
    @media (max-width: 576px) {
      .auto-container { padding-left: 16px !important; padding-right: 16px !important; }
      .compat-section { padding-top: 24px !important; padding-bottom: 32px !important; }
      .compat-title { font-size: 22px !important; line-height: 1.25 !important; margin: 6px 0 16px !important; padding: 0 6px !important; }
      .compat-lead { padding: 0 6px !important; }
      .compat-video, .compat-carousel { margin-bottom: 18px !important; }
      .compat-iframe-wrap { border-radius: 10px !important; }
      .compat-iframe-wrap > div { border-radius: 10px !important; overflow: hidden !important; }
      #myCarousel .carousel-item img { max-width: 100% !important; max-height: 240px !important; padding: 0 !important; }
      #myCarousel .carousel-control-prev { left: 4px !important; }
      #myCarousel .carousel-control-next { right: 4px !important; }
    }
    @media (min-width: 577px) and (max-width: 992px) {
      .auto-container { padding-left: 24px !important; padding-right: 24px !important; }
      .compat-title { font-size: 26px !important; }
      #myCarousel .carousel-item img { max-width: 90% !important; max-height: 300px !important; }
    }
  </style>
  <?php if (isset($_GET['debugcms']) && $_GET['debugcms'] == '1') { ?>
    <div style="background:#f8fafc;border:1px solid #e2e8f0;color:#0f172a;font-size:12px;padding:10px;border-radius:6px;margin:10px 0;">
      <?php if (isset($this->debug_bloque8)) { ?>
        <strong>Bloque 8 (Banner) Debug</strong>
        <pre style="white-space:pre-wrap;margin:6px 0;"><?php echo htmlspecialchars(json_encode($this->debug_bloque8, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES)); ?></pre>
      <?php } ?>
      <?php if (isset($this->debug_bloque9)) { ?>
        <strong>Bloque 9 (Video+Carrusel) Debug</strong>
        <pre style="white-space:pre-wrap;margin:6px 0;"><?php echo htmlspecialchars(json_encode($this->debug_bloque9, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES)); ?></pre>
      <?php } ?>
      <?php if (isset($this->debug_bloque10)) { ?>
        <strong>Bloque 10 (Ayuda) Debug</strong>
        <pre style="white-space:pre-wrap;margin:6px 0;"><?php echo htmlspecialchars(json_encode($this->debug_bloque10, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES)); ?></pre>
      <?php } ?>
    </div>
  <?php } ?>

  <!-- BANNER -->
  <?php if (!empty($this->banner_compatibilidad)) { ?>
  <div style="position: relative; max-width: 100%; overflow: hidden; margin-top: 0;">
      <div style="display: block; width: 100%;">
          <?php $href = isset($this->banner_compatibilidad_link) ? trim((string)$this->banner_compatibilidad_link) : ''; ?>
          <?php if ($href) { ?><a href="<?php echo htmlspecialchars($href); ?>" style="display:block;"><?php } ?>
          <img src="<?php echo htmlspecialchars($this->banner_compatibilidad); ?>" 
              style="width: 100%; height: 300px; object-fit: cover; display: block;">
          <?php if ($href) { ?></a><?php } ?>
      </div>
  </div>
  <?php } else { ?>
  <div style="position: relative; max-width: 100%; overflow: hidden; margin-top: 0; min-height: 300px; border-radius:12px; background:linear-gradient(180deg,#eef5fb 0%,#e6eef7 100%); border:1px solid #d9e5f0; box-shadow:0 6px 18px rgba(15, 23, 42, 0.05);"></div>
  <?php } ?>
  <section class="event-detail" style="padding: 60px 0; background-color:#ffffff;">
    <div class="auto-container">
        <div class="row" style="justify-content: center;">
            <div class="col-lg-8 col-md-10 col-sm-12 text-center" style="margin-bottom: 30px;">
                <b class="compat-lead" style="color:#0e2035; font-size:1.05rem; line-height:1.8; font-weight:500; letter-spacing:0.2px; display:block; font-family:'Baloo 2', cursive;">
                    Para poder revisar la compatibilidad de tu equipo es necesario que obtengas el código IMEI* de tu teléfono
                </b>
                <div class="d-flex align-items-center" style="max-width: 600px; margin: 20px auto 0; gap: 10px; display: flex; justify-content: center;">
                    <div class="spin1 spinner-border text-success" role="status" style="display:none;">
                        <div class="spinner"></div>
                    </div> 		 
                    <div class="form-group" style="flex: 1;">
                        <input type="text" name="x1" id="x1" placeholder="Ingresa tu Código IMEI" required
                               style="width: 100%; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; outline: none; box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition: border-color 0.2s;" onfocus="this.style.borderColor='#17a2b8'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                    <button id="consultar-imei" 
                            style="background-color:#17a2b8; color:#fff; border: none; padding: 12px 26px; border-radius: 6px; font-size: 1rem; font-weight:600; cursor: pointer; transition: background 0.25s, transform 0.15s; box-shadow:0 6px 16px rgba(23,162,184,0.20);"
                            onmouseover="this.style.backgroundColor='#128a99'; this.style.transform='translateY(-1px)';" 
                            onmouseout="this.style.backgroundColor='#17a2b8'; this.style.transform='translateY(0)';">
                        Consultar
                    </button>             
                </div>
            </div>
        </div>
    </div>
  </section>
  <!-- VIDEO Y CARRUSEL JUNTOS -->
  <section class="event-detail compat-section" style="padding: 10px 0 40px; background:#ffffff;">
    <div class="row align-items-center" style="display: flex; align-items: center;">
      <!-- TÍTULO -->
      <?php if (!empty($this->compat_vc['titulo'][0])) { ?>
      <div class="col-lg-12 col-md-12 col-sm-12 text-center" style="margin-bottom: 30px; margin-top: 34px;"> 		
        <h2 class="subtitulo-seccion-black compat-title" style="margin:0; font-size:32px; font-weight:800; color:#0ea5a6; letter-spacing:0.2px;">&nbsp;<?php echo $this->compat_vc['titulo'][0]; ?></h2>
      </div>
      <?php } ?>
      <!-- VIDEO -->
      <?php if (!empty($this->compat_vc['video'][0])) { ?>
      <div class="col-lg-6 col-md-6 col-sm-12 text-center compat-video" style="margin-bottom: 30px;">
        <?php 
          $raw = trim((string)$this->compat_vc['video'][0]);
          $u = $raw;
          if (stripos($u, 'http://') === 0) { $u = 'https://' . substr($u, 7); }
          if (stripos($u, 'youtube.com/watch') !== false) {
            parse_str(parse_url($u, PHP_URL_QUERY) ?: '', $q);
            $vid = isset($q['v']) ? $q['v'] : '';
            if ($vid !== '') { $u = 'https://www.youtube.com/embed/' . $vid; }
          } elseif (preg_match('#youtu\.be/([A-Za-z0-9_-]{6,})#i', $u, $m)) {
            $u = 'https://www.youtube.com/embed/' . $m[1];
          } elseif (preg_match('#youtube\.com/shorts/([A-Za-z0-9_-]{6,})#i', $u, $m)) {
            $u = 'https://www.youtube.com/embed/' . $m[1];
          }
          if (strpos($u, 'youtube.com/embed/') !== false && strpos($u, '?') === false) {
            $u .= '?rel=0&modestbranding=1';
          }
        ?>
        <div class="compat-iframe-wrap" style="position:relative;width:100%;max-width:720px;margin:0 auto;border-radius:12px;overflow:hidden;box-shadow:0 12px 28px rgba(2,12,27,0.10);">
          <div style="position:relative;padding-bottom:56.25%;height:0;">
            <iframe id="videoimei" src="<?php echo htmlspecialchars($u); ?>" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </div>
      </div>
      <?php } else { ?>
      <div class="col-lg-6 col-md-6 col-sm-12 text-center" style="margin-bottom: 30px;">
        <div style="width:100%; height:400px; background:#eef3f7; border-radius:12px;"></div>
      </div>
      <?php } ?>
      <!-- CARRUSEL -->
      <div class="col-lg-6 col-md-6 col-sm-12 text-center" style="margin-bottom: 30px;">
        <?php
          $imgs = isset($this->compat_vc['imagen']) && is_array($this->compat_vc['imagen']) ? $this->compat_vc['imagen'] : [];
          // Normaliza: si cada entrada es arreglo, toma 'imagen' o 'url'
          $normImgs = [];
          foreach ($imgs as $it) {
            if (is_array($it)) {
              $src = $it['imagen'] ?? ($it['url'] ?? null);
              if (!$src && !empty($it)) { $first = reset($it); if (is_string($first)) $src = $first; }
              if ($src) { $normImgs[] = $src; }
            } elseif (is_string($it)) {
              $normImgs[] = $it;
            }
          }
          $imgs = $normImgs;
        ?>
        <?php if (!empty($imgs)) { ?>
        <style>
          /* Asegura visibilidad correcta sin CSS de Bootstrap */
          #myCarousel .carousel-item { display: none; position: relative !important; transition: none !important; transform: none !important; left: 0 !important; }
          #myCarousel .carousel-item.active { display: block; transition: none !important; transform: none !important; }
          /* Anula estados de transición de Bootstrap (si el CSS global está presente) */
          #myCarousel .carousel-item-next,
          #myCarousel .carousel-item-prev,
          #myCarousel .carousel-item-start,
          #myCarousel .carousel-item-end { transition: none !important; transform: none !important; }
          #myCarousel .carousel-inner { position: relative; overflow: hidden; }
          /* Oculta texto accesible si no hay utilidades de Bootstrap */
          #myCarousel .visually-hidden { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
          /* Botones: estilo flotante circular, sin barras laterales */
          #myCarousel .carousel-control-prev,
          #myCarousel .carousel-control-next {
            position:absolute; top:50%; transform:translateY(-50%); width:auto; height:auto;
            background:transparent; border:none; padding:0; color:inherit; box-shadow:none;
          }
          #myCarousel .carousel-control-prev { left: 8px; }
          #myCarousel .carousel-control-next { right: 8px; }
          #myCarousel .carousel-control-prev:focus,
          #myCarousel .carousel-control-next:focus { outline:none; box-shadow:none; }
        </style>
        <div id="myCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000" style="position: relative;">
          <div class="carousel-inner">
            <?php foreach ($imgs as $i => $src) { $active = $i === 0 ? ' active' : ''; ?>
              <div class="carousel-item<?php echo $active; ?>">
                <img src="<?php echo htmlspecialchars($src); ?>" alt="Imagen <?php echo $i+1; ?>"
                  style="display: block; margin: 0 auto; max-width: 90%; max-height: 350px; object-fit: contain;">
              </div>
            <?php } ?>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev"
            style="display:flex;align-items:center;justify-content:center;z-index:3;">
            <i class="fa fa-arrow-left" style="color:#0ea5a6; font-size: 28px; background: #fff; padding: 10px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"></i>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next"
            style="display:flex;align-items:center;justify-content:center;z-index:3;">
            <i class="fa fa-arrow-right" style="color:#0ea5a6; font-size: 28px; background: #fff; padding: 10px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"></i>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>
        <script>
          (function(){
            var el = document.getElementById('myCarousel');
            if (!el) return;
            var items = el.querySelectorAll('.carousel-item');
            if (!items.length) return;
            var prev = document.querySelector('[data-bs-target="#myCarousel"][data-bs-slide="prev"]');
            var next = document.querySelector('[data-bs-target="#myCarousel"][data-bs-slide="next"]');
            var idx = 0;
            function applyState(i){
              for (var k=0;k<items.length;k++){
                if (k===i){ items[k].classList.add('active'); items[k].style.display='block'; }
                else { items[k].classList.remove('active'); items[k].style.display='none'; }
              }
            }
            function go(dir){
              idx = dir==='prev' ? (idx-1+items.length)%items.length : (idx+1)%items.length;
              applyState(idx);
            }
            // init
            applyState(0);
            if (prev) prev.addEventListener('click', function(e){ e.preventDefault(); go('prev'); });
            if (next) next.addEventListener('click', function(e){ e.preventDefault(); go('next'); });
            // autoplay
            var timer = setInterval(function(){ go('next'); }, 5000);
            el.addEventListener('mouseenter', function(){ clearInterval(timer); });
            el.addEventListener('mouseleave', function(){ timer = setInterval(function(){ go('next'); }, 5000); });
          })();
        </script>
        <?php } else { ?>
        <div style="width:100%; height:400px; border-radius:12px; background:linear-gradient(180deg,#eef5fb 0%,#e6eef7 100%); border:1px solid #d9e5f0; box-shadow:0 6px 18px rgba(15,23,42,.05);"></div>
        <?php } ?>
      </div>
      
    </div>
  </section>
  <!-- Sección de ayuda removida hasta tener datos CMS -->

  <!-- AYUDA WHATSAPP -->
  <?php 
    $waNum = '';
    $waUrl = isset($this->compat_ayuda_link) && is_string($this->compat_ayuda_link) ? trim((string)$this->compat_ayuda_link) : '';
    $waMsg = isset($this->compat_ayuda_msg) && is_string($this->compat_ayuda_msg) ? trim((string)$this->compat_ayuda_msg) : '';
    // helper para leer valores arbitrarios (arreglo plano o anidado)
    $scanValues = function($arr) use (&$waUrl, &$waNum, &$waMsg) {
      foreach ($arr as $key => $val) {
        if (is_array($val)) {
          foreach ($val as $k => $vv) {
            if (!is_string($vv)) { continue; }
            $s = trim($vv);
            if (!$waUrl && (stripos($s,'wa.me/')!==false || stripos($s,'whatsapp')!==false)) { $waUrl = $s; }
            if (!$waNum) { $d = preg_replace('/\D+/','', $s); if (strlen($d) >= 8) { $waNum = $d; } }
            if (!$waMsg) {
              $isUrl = stripos($s,'http')===0 || stripos($s,'wa.me/')!==false || stripos($s,'whatsapp')!==false;
              if (!$isUrl && mb_strlen($s,'UTF-8') >= 6) { $waMsg = $s; }
            }
          }
        } elseif (is_string($val)) {
          $s = trim($val);
          if (!$waUrl && (stripos($s,'wa.me/')!==false || stripos($s,'whatsapp')!==false)) { $waUrl = $s; }
          if (!$waNum) { $d = preg_replace('/\D+/','', $s); if (strlen($d) >= 8) { $waNum = $d; } }
          if (!$waMsg) {
            $isUrl = stripos($s,'http')===0 || stripos($s,'wa.me/')!==false || stripos($s,'whatsapp')!==false;
            if (!$isUrl && mb_strlen($s,'UTF-8') >= 6) { $waMsg = $s; }
          }
        }
      }
    };
    if (!$waUrl && isset($this->compat_ayuda) && is_array($this->compat_ayuda)) { $scanValues($this->compat_ayuda); }
    if (!$waUrl && isset($this->compat_vc) && is_array($this->compat_vc)) { foreach ($this->compat_vc as $x) { if (is_array($x)) { $scanValues($x); } } }
    // Normalizar URL/num
    if (!$waUrl && $waNum) { $waUrl = 'https://wa.me/'.$waNum; }
    if ($waUrl && stripos($waUrl,'http') !== 0) { $waUrl = 'https://'.$waUrl; }
    // Adjuntar mensaje si no viene ya en la URL
    if ($waUrl && $waMsg) {
      if (stripos($waUrl,'wa.me/')!==false || stripos($waUrl,'api.whatsapp.com')!==false) {
        if (stripos($waUrl,'?text=')===false && stripos($waUrl,'&text=')===false) {
          $sep = (strpos($waUrl,'?')===false) ? '?' : '&';
          $waUrl .= $sep.'text='.rawurlencode($waMsg);
        }
      }
    }
  ?>
  <section style="padding: 30px 0 50px; background:#ffffff;">
    <div class="auto-container">
      <?php if (!empty($waUrl)) { ?>
      <div style="text-align:center; font-family:'Montserrat', sans-serif; font-weight:700; font-size:20px; color:#0b2238;">
        ¿Necesitas ayuda? Escríbenos
        <a href="<?php echo htmlspecialchars($waUrl); ?>" target="_blank" rel="noopener" aria-label="WhatsApp"
           style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:#25D366;margin-left:10px;text-decoration:none;box-shadow:0 4px 10px rgba(37,211,102,0.25);">
          <i class="fab fa-whatsapp" style="font-size:20px;color:#ffffff;"></i>
        </a>
      </div>
      <?php } else { ?>
      <div style="text-align:center; font-family:'Montserrat', sans-serif;">
        <div style="display:inline-flex; align-items:center; gap:10px;">
          <div style="height:22px; width:260px; background:#e9edf1; border-radius:8px;"></div>
          <span style="display:inline-block; width:26px; height:26px; border-radius:50%; background:#dfe7f0; border:1px solid #cfd9e4;"></span>
        </div>
      </div>
      <?php } ?>
    </div>
  </section>

</div>
