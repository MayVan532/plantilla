<div class="personas-main-content" style="background:#fbfdff; min-height:100vh; padding:0;">

  <div class="container-fluid">
    <div class="row no-gutters">
      <?php $activeMenu = 'miperfil'; require __DIR__ . '/_sidebarUsuarios.phtml'; ?>
      <div class="col-12 col-lg-10" style="padding-left:0; padding-right:0;">
        <?php require __DIR__ . '/_headerUsuarios.phtml'; ?>
        <div style="padding:16px 24px 24px 24px;">
          <div style="font-size:18px; font-weight:600; color:#111827; margin-bottom:14px; text-align:left;">Mi Perfil</div>

          <?php if (isset($this->_error) && $this->_error) { ?>
            <div id="profileErrorOverlay" style="position:fixed; inset:0; background:rgba(15,23,42,0.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:10000;">
              <div role="dialog" aria-modal="true" style="width:100%; max-width:520px; background:#ffffff; border-radius:18px; box-shadow:0 24px 80px rgba(15,23,42,0.35); border:1px solid rgba(220,38,38,0.18); overflow:hidden;">
                <div style="padding:16px 18px; background:linear-gradient(90deg,#ef4444 0%,#f97316 100%); color:#ffffff; font-weight:800; font-size:14px; display:flex; justify-content:space-between; align-items:center;">
                  <div>Error</div>
                  <button type="button" id="profileErrorClose" style="border:none; background:rgba(255,255,255,0.18); color:#ffffff; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer;">Cerrar</button>
                </div>
                <div style="padding:18px 18px 20px;">
                  <div style="display:flex; gap:12px; align-items:flex-start;">
                    <div style="width:42px; height:42px; border-radius:999px; background:rgba(239,68,68,0.10); display:flex; align-items:center; justify-content:center; border:1px solid rgba(239,68,68,0.25); flex:0 0 auto;">
                      <i class="fas fa-times" style="color:#dc2626;"></i>
                    </div>
                    <div style="flex:1;">
                      <div style="font-size:16px; font-weight:900; color:#0f172a; margin-bottom:6px;">No se pudo completar</div>
                      <div style="font-size:13px; color:#475569; line-height:1.6;">
                        <?php echo htmlspecialchars((string)$this->_error); ?>
                      </div>
                      <div style="margin-top:12px; font-size:12px; color:#64748b;">Este mensaje se cerrará automáticamente.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <script>
              (function(){
                var overlay = document.getElementById('profileErrorOverlay');
                var closeBtn = document.getElementById('profileErrorClose');
                function close(){
                  if (!overlay) return;
                  overlay.style.display = 'none';
                }
                if (closeBtn) closeBtn.addEventListener('click', close);
                if (overlay) overlay.addEventListener('click', function(e){
                  if (e.target === overlay) close();
                });
                window.setTimeout(close, 4500);
              })();
            </script>
          <?php } ?>

          <?php if (isset($this->_success) && $this->_success) { ?>
            <div id="profileSuccessOverlay" style="position:fixed; inset:0; background:rgba(15,23,42,0.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:9999;">
              <div role="dialog" aria-modal="true" style="width:100%; max-width:520px; background:#ffffff; border-radius:18px; box-shadow:0 24px 80px rgba(15,23,42,0.35); border:1px solid rgba(2,132,199,0.12); overflow:hidden;">
                <div style="padding:16px 18px; background:linear-gradient(90deg,#00bcd4 0%,#06b6d4 35%,#22c55e 100%); color:#ffffff; font-weight:800; font-size:14px; display:flex; justify-content:space-between; align-items:center;">
                  <div>Actualización</div>
                  <button type="button" id="profileSuccessClose" style="border:none; background:rgba(255,255,255,0.18); color:#ffffff; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer;">Cerrar</button>
                </div>
                <div style="padding:18px 18px 20px;">
                  <div style="display:flex; gap:12px; align-items:flex-start;">
                    <div style="width:42px; height:42px; border-radius:999px; background:rgba(34,197,94,0.12); display:flex; align-items:center; justify-content:center; border:1px solid rgba(34,197,94,0.25); flex:0 0 auto;">
                      <i class="fas fa-check" style="color:#16a34a;"></i>
                    </div>
                    <div style="flex:1;">
                      <div style="font-size:16px; font-weight:900; color:#0f172a; margin-bottom:6px;">Perfil actualizado</div>
                      <div style="font-size:13px; color:#475569; line-height:1.6;">
                        <?php echo htmlspecialchars((string)$this->_success); ?>
                      </div>
                      <div style="margin-top:12px; font-size:12px; color:#64748b;">Este mensaje se cerrará automáticamente.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <script>
              (function(){
                var overlay = document.getElementById('profileSuccessOverlay');
                var closeBtn = document.getElementById('profileSuccessClose');
                function close(){
                  if (!overlay) return;
                  overlay.style.display = 'none';
                }
                if (closeBtn) closeBtn.addEventListener('click', close);
                if (overlay) overlay.addEventListener('click', function(e){
                  if (e.target === overlay) close();
                });
                window.setTimeout(close, 3000);
              })();
            </script>
          <?php } ?>

          <?php if (isset($_GET['debugcms']) && $_GET['debugcms']=='1' && isset($this->debug_profile_api)) { ?>
            <pre style="background:#f8fafc;border:1px solid #e2e8f0;color:#0f172a;font-size:12px;padding:10px;border-radius:6px;margin:10px 0;white-space:pre-wrap;">PROFILE API DEBUG: <?php echo htmlspecialchars(json_encode($this->debug_profile_api, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES)); ?></pre>
          <?php } ?>

          <?php $p = (isset($this->profile) && is_array($this->profile)) ? $this->profile : []; ?>
          <?php $valNombre = isset($p['nombre']) ? (string)$p['nombre'] : ''; ?>
          <?php $valApPat = isset($p['apellido_paterno']) ? (string)$p['apellido_paterno'] : ''; ?>
          <?php $valApMat = isset($p['apellido_materno']) ? (string)$p['apellido_materno'] : ''; ?>
          <?php $valTel = isset($p['numero_telefono']) ? (string)$p['numero_telefono'] : (isset($p['telefono']) ? (string)$p['telefono'] : ''); ?>
          <?php $valEmail = isset($p['email']) ? (string)$p['email'] : ''; ?>
          <?php $valCodigoConvenio = isset($p['codigo_convenio']) ? (string)$p['codigo_convenio'] : ''; ?>

          <div class="row" style="margin:0 -8px;">
            <div class="col-12 col-lg-8" style="padding:0 8px 16px 8px;">
              <div style="background:#ffffff; border-radius:18px; padding:24px 24px 20px 24px; box-shadow:0 18px 40px rgba(15,23,42,.08);">
                <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:18px;">
                  <div style="width:80px; height:80px; border-radius:999px; border:2px solid #e5e7eb; display:flex; align-items:center; justify-content:center; margin-bottom:10px;">
                    <i class="fas fa-user" style="font-size:32px; color:#6b7280;"></i>
                  </div>
                </div>

                <form method="post" action="<?php echo BASE_URL; ?>usuarios/miperfil">
                  <input type="hidden" name="guardar_perfil" value="1" />
                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Nombre:</div>
                  <div style="margin-bottom:10px;"><input id="perfil_nombre" name="nombre" type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px;" value="<?php echo htmlspecialchars($valNombre, ENT_QUOTES, 'UTF-8'); ?>" data-initial="<?php echo htmlspecialchars($valNombre, ENT_QUOTES, 'UTF-8'); ?>" /></div>

                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Apellido Paterno:</div>
                  <div style="margin-bottom:10px;"><input id="perfil_ap_pat" name="apellido_paterno" type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px;" value="<?php echo htmlspecialchars($valApPat, ENT_QUOTES, 'UTF-8'); ?>" data-initial="<?php echo htmlspecialchars($valApPat, ENT_QUOTES, 'UTF-8'); ?>" /></div>

                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Apellido Materno:</div>
                  <div style="margin-bottom:10px;"><input id="perfil_ap_mat" name="apellido_materno" type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px;" value="<?php echo htmlspecialchars($valApMat, ENT_QUOTES, 'UTF-8'); ?>" data-initial="<?php echo htmlspecialchars($valApMat, ENT_QUOTES, 'UTF-8'); ?>" /></div>

                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Teléfono:</div>
                  <div style="margin-bottom:10px;"><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px; background:#f1f5f9;" value="<?php echo htmlspecialchars($valTel, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>

                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Correo electrónico:</div>
                  <div style="margin-bottom:10px;"><input id="perfil_email" name="email" type="email" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px;" value="<?php echo htmlspecialchars($valEmail, ENT_QUOTES, 'UTF-8'); ?>" data-initial="<?php echo htmlspecialchars($valEmail, ENT_QUOTES, 'UTF-8'); ?>" /></div>

                  <?php /*
                  <div style="margin-bottom:10px; font-size:13px; color:#374151;">Código de convenio:</div>
                  <div style="margin-bottom:10px;"><input name="codigo_convenio" type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:8px 10px; font-size:14px;" value="<?php echo htmlspecialchars($valCodigoConvenio, ENT_QUOTES, 'UTF-8'); ?>" /></div>
                  */ ?>

                  <div style="display:flex; justify-content:flex-end;">
                    <button id="btnGuardarPerfil" type="submit" style="border:1px solid #00bcd4; background:#00bcd4; color:#f9fafb; font-size:14px; padding:8px 18px; border-radius:4px; font-weight:600;">Guardar</button>
                  </div>
                </form>

              </div>
            </div>

            <div class="col-12 col-lg-4" style="padding:0 8px 16px 8px;">
              <?php $valId = isset($p['id']) ? (string)$p['id'] : ''; ?>
              <?php $valFechaCreacion = isset($p['fecha_creacion']) ? (string)$p['fecha_creacion'] : ''; ?>
              <?php $valUltimoLogin = isset($p['fecha_ultimo_login']) ? (string)$p['fecha_ultimo_login'] : ''; ?>
              <?php $valNombreConvenio = isset($p['nombre_convenio']) ? (string)$p['nombre_convenio'] : ''; ?>
              <?php $valDescripcion = isset($p['descripcion']) ? (string)$p['descripcion'] : ''; ?>
              <?php $valEstatus = isset($p['estatus']) ? (string)$p['estatus'] : ''; ?>
              <?php $valFechaInicio = isset($p['fecha_inicio']) ? (string)$p['fecha_inicio'] : ''; ?>
              <?php $valFechaFin = isset($p['fecha_fin']) ? (string)$p['fecha_fin'] : ''; ?>
              <?php
                $estatusTxt = '';
                $estatusNorm = trim($valEstatus);
                if ($estatusNorm === '1') { $estatusTxt = 'Activo'; }
                elseif ($estatusNorm === '0') { $estatusTxt = 'Inactivo'; }
                $hasConvenio = (trim((string)$valCodigoConvenio) !== '' || trim((string)$valNombreConvenio) !== '');
              ?>

              <?php
                $fmtCreacion = $valFechaCreacion;
                $fmtUltimoLogin = $valUltimoLogin;
                try {
                  if ($valFechaCreacion !== '') {
                    $dt = new DateTime($valFechaCreacion);
                    $fmtCreacion = $dt->format('d/m/Y h:i A');
                  }
                } catch (Throwable $e) {
                  $fmtCreacion = $valFechaCreacion;
                }
                try {
                  if ($valUltimoLogin !== '') {
                    $dt2 = new DateTime($valUltimoLogin);
                    $fmtUltimoLogin = $dt2->format('d/m/Y h:i A');
                  }
                } catch (Throwable $e) {
                  $fmtUltimoLogin = $valUltimoLogin;
                }
              ?>

              <div style="background:#ffffff; border-radius:18px; padding:18px 20px 18px 20px; box-shadow:0 18px 40px rgba(15,23,42,.08); margin-bottom:16px;">
                <div style="font-size:14px; font-weight:600; color:#111827; margin-bottom:10px;">Información</div>

                <div style="margin-bottom:8px; font-size:12px; color:#374151;">ID de usuario</div>
                <div style="margin-bottom:12px;"><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($valId, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>

                <div style="margin-bottom:8px; font-size:12px; color:#374151;">Fecha de creación</div>
                <div style="margin-bottom:12px;"><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($fmtCreacion, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>

                <div style="margin-bottom:8px; font-size:12px; color:#374151;">Último login</div>
                <div><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($fmtUltimoLogin, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>
              </div>

              <div style="background:#ffffff; border-radius:18px; padding:18px 20px 18px 20px; box-shadow:0 18px 40px rgba(15,23,42,.08); min-height:160px; display:flex; flex-direction:column; justify-content:space-between;">
                <div>
                  <div style="font-size:14px; font-weight:600; color:#111827; margin-bottom:10px;">Convenio</div>

                  <div style="margin-bottom:8px; font-size:12px; color:#374151;">Nombre</div>
                  <div style="margin-bottom:12px;"><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($valNombreConvenio, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>

                  <div style="margin-bottom:8px; font-size:12px; color:#374151;">Código</div>
                  <form method="post" action="<?php echo BASE_URL; ?>usuarios/miperfil" style="margin:0;">
                    <div style="margin-bottom:10px;"><input id="convenio_codigo" name="codigo_convenio" type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px;" value="<?php echo htmlspecialchars($valCodigoConvenio, ENT_QUOTES, 'UTF-8'); ?>" data-initial="<?php echo htmlspecialchars($valCodigoConvenio, ENT_QUOTES, 'UTF-8'); ?>" /></div>

                    <div style="display:flex; gap:10px; justify-content:flex-end; margin-bottom:12px;">
                      <button id="btnGuardarConvenio" type="submit" name="guardar_convenio" value="1" style="border:1px solid #00bcd4; background:#00bcd4; color:#f9fafb; font-size:12px; padding:7px 12px; border-radius:4px; font-weight:700;">Guardar</button>
                      <?php if ($hasConvenio) { ?>
                        <button type="submit" name="eliminar_convenio" value="1" onclick="return confirm('¿Seguro que deseas desvincular tu convenio?');" style="border:1px solid #ef4444; background:#ffffff; color:#ef4444; font-size:12px; padding:7px 12px; border-radius:4px; font-weight:700;">Desvincular</button>
                      <?php } ?>
                    </div>
                  </form>

                  <div style="margin-bottom:8px; font-size:12px; color:#374151;">Estatus</div>
                  <div style="margin-bottom:12px;"><input type="text" style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($estatusTxt !== '' ? $estatusTxt : $valEstatus, ENT_QUOTES, 'UTF-8'); ?>" readonly /></div>

                  <div style="margin-bottom:8px; font-size:12px; color:#374151;">Vigencia</div>
                  <div style="display:flex; gap:10px;">
                    <input type="text" style="flex:1; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($valFechaInicio, ENT_QUOTES, 'UTF-8'); ?>" readonly />
                    <input type="text" style="flex:1; border:1px solid #d1d5db; border-radius:4px; padding:7px 9px; font-size:13px; background:#f1f5f9;" value="<?php echo htmlspecialchars($valFechaFin, ENT_QUOTES, 'UTF-8'); ?>" readonly />
                  </div>

                  <?php if ($valDescripcion !== '') { ?>
                    <div style="margin-top:12px; font-size:12px; color:#374151;">Descripción</div>
                    <div style="margin-top:6px; font-size:12px; color:#0f172a; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px; white-space:pre-wrap;"><?php echo htmlspecialchars($valDescripcion, ENT_QUOTES, 'UTF-8'); ?></div>
                  <?php } ?>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    function norm(v){
      return (v == null ? '' : String(v)).trim();
    }

    function setDisabled(btn, disabled){
      if (!btn) return;
      btn.disabled = !!disabled;
      if (btn.disabled) {
        btn.style.background = '#e5e7eb';
        btn.style.borderColor = '#e5e7eb';
        btn.style.color = '#6b7280';
        btn.style.boxShadow = 'none';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.style.background = '#00bcd4';
        btn.style.borderColor = '#00bcd4';
        btn.style.color = '#f9fafb';
        btn.style.cursor = 'pointer';
      }
    }

    var inNombre = document.getElementById('perfil_nombre');
    var inApPat = document.getElementById('perfil_ap_pat');
    var inApMat = document.getElementById('perfil_ap_mat');
    var inEmail = document.getElementById('perfil_email');
    var btnPerfil = document.getElementById('btnGuardarPerfil');

    var inConv = document.getElementById('convenio_codigo');
    var btnConv = document.getElementById('btnGuardarConvenio');

    function refreshPerfil(){
      if (!btnPerfil) return;
      var changed = false;
      if (inNombre && norm(inNombre.value) !== norm(inNombre.getAttribute('data-initial'))) changed = true;
      if (inApPat && norm(inApPat.value) !== norm(inApPat.getAttribute('data-initial'))) changed = true;
      if (inApMat && norm(inApMat.value) !== norm(inApMat.getAttribute('data-initial'))) changed = true;
      if (inEmail && norm(inEmail.value) !== norm(inEmail.getAttribute('data-initial'))) changed = true;
      setDisabled(btnPerfil, !changed);
    }

    function refreshConvenio(){
      if (!btnConv) return;
      var cur = inConv ? norm(inConv.value) : '';
      var ini = inConv ? norm(inConv.getAttribute('data-initial')) : '';
      var enabled = (cur !== '' && cur !== ini);
      setDisabled(btnConv, !enabled);
    }

    function bindInput(el, fn){
      if (!el) return;
      el.addEventListener('input', fn);
      el.addEventListener('change', fn);
      el.addEventListener('keyup', fn);
    }

    bindInput(inNombre, refreshPerfil);
    bindInput(inApPat, refreshPerfil);
    bindInput(inApMat, refreshPerfil);
    bindInput(inEmail, refreshPerfil);
    bindInput(inConv, refreshConvenio);

    refreshPerfil();
    refreshConvenio();
  })();
</script>
