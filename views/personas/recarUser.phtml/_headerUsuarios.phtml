<?php
  $userEmail = class_exists('Session') ? Session::get('email_usuario') : null;
  $userLabel = $userEmail ?: 'Perfil';

  // Logo dinámico para el avatar del header (por cliente/página CMS)
  $headerLogo = null;
  $headerLogoDebug = null;

  try {
    if (class_exists('Illuminate\\Database\\Capsule\\Manager')) {
      $capsule = Illuminate\Database\Capsule\Manager::connection('cms');
      $cmsPageId = defined('CMS_PAGE_ID') ? (int)CMS_PAGE_ID : 0;
      $logoBlockId = 0;

      if ($cmsPageId > 0) {
        // 1) Resolver id_seccion "personas" para esta página
        $secRow = $capsule->table('secciones_cms')
          ->select(['id_seccion','nombre'])
          ->where('id_pagina', $cmsPageId)
          ->where('visible', 1)
          ->get();

        $secId = 0;
        foreach ($secRow as $r) {
          $name = strtolower(trim((string)($r->nombre ?? '')));
          if ($name === 'personas') {
            $secId = (int)($r->id_seccion ?? 0);
            break;
          }
        }

        // 2) Buscar bloque de tipo banner con título "Logotipo" para esa sección/página
        if ($secId > 0) {
          $blockRow = $capsule->table('bloques_cms')
            ->select(['id_bloque'])
            ->where('id_pagina', $cmsPageId)
            ->where('id_seccion', $secId)
            ->where('visible', 1)
            ->where('tipo_bloque', 'banner')
            ->where('titulo', 'Logotipo')
            ->orderBy('orden', 'asc')
            ->first();

          if ($blockRow && isset($blockRow->id_bloque)) {
            $logoBlockId = (int)$blockRow->id_bloque;
          }
        }
      }

      // 3) Leer primer elemento de tipo imagen visible para ese bloque
      if ($logoBlockId > 0) {
        $row = $capsule->table('elementos_bloques')
          ->select(['contenido'])
          ->where('id_bloque', $logoBlockId)
          ->where('tipo', 'imagen')
          ->where(function($q){ $q->where('visible', 1)->orWhereNull('visible'); })
          ->orderBy('id_elemento', 'asc')
          ->first();

        if ($row && is_string($row->contenido ?? null)) {
          $cont = trim((string)$row->contenido);
          if ($cont !== '') {
            $headerLogo = $cont;
          }
        }
      }

      if (isset($_GET['debugcms']) && $_GET['debugcms'] === '1') {
        $headerLogoDebug = [
          'cmsPageId' => $cmsPageId,
          'logoBlockId' => $logoBlockId,
        ];
      }
    }
  } catch (\Throwable $e) {
    $headerLogo = null;
    if (isset($_GET['debugcms']) && $_GET['debugcms'] === '1') {
      $headerLogoDebug = [
        'error' => $e->getMessage(),
      ];
    }
  }
?>

<?php if (isset($_GET['debugcms']) && $_GET['debugcms'] === '1' && $headerLogoDebug !== null) { ?>
  <pre style="background:#f8fafc;border:1px solid #e2e8f0;color:#0f172a;font-size:12px;padding:6px;border-radius:4px;margin:4px 0;white-space:pre-wrap;">
HEADER_LOGO_DEBUG: <?php echo htmlspecialchars(json_encode($headerLogoDebug, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES)); ?>
  </pre>
<?php } ?>

<div style="background:#ffffff; border-bottom:3px solid #00bcd4; box-shadow:0 4px 12px rgba(15,23,42,.06); padding:10px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:10;">
  <div style="display:flex; flex-direction:column; gap:2px;">
    <span style="font-size:14px; font-weight:600; color:#111827;">Panel de usuarios</span>
    <span style="font-size:12px; color:#6b7280;">LikePhone</span>
  </div>

  <div style="display:flex; align-items:center; gap:16px; color:#6b7280; font-size:14px; position:relative;">
    <!-- Botón de notificaciones rediseñado -->
    <div id="notifToggle"
         onmouseover="this.style.background='#e2f3ff'; this.style.boxShadow='0 0 0 2px #bae6fd';"
         onmouseout="this.style.background='#f1f5f9'; this.style.boxShadow='none';"
         style="position:relative; cursor:pointer; display:flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:999px; background:#f1f5f9; transition:background-color .2s, box-shadow .2s;">
      <i class="far fa-bell" style="font-size:16px; color:#0f172a;"></i>
      <span id="notifBadge"
            style="position:absolute; top:-4px; right:-2px; background:#ef4444; color:#ffffff; border-radius:999px; padding:0 5px; font-size:10px; font-weight:700; line-height:16px; min-width:16px; text-align:center; box-shadow:0 0 0 2px #ffffff;">
        0
      </span>
    </div>

    <!-- SIN icono de signo de interrogación -->

    <div id="userMenuToggle" style="display:flex; align-items:center; gap:12px; cursor:pointer;">
      <div style="width:96px; height:34px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
        <?php if (!empty($headerLogo)) { ?>
          <img src="<?php echo htmlspecialchars($headerLogo, ENT_QUOTES, 'UTF-8'); ?>" alt="LikePhone" style="width:100%; height:auto; object-fit:contain; display:block;">
        <?php } else { ?>
          <span style="color:#00bcd4; font-weight:700; font-size:18px;">LP</span>
        <?php } ?>
      </div>
      <span style="font-size:13px; color:#111827; font-weight:500; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
        <?php echo htmlspecialchars($userLabel, ENT_QUOTES, 'UTF-8'); ?>
      </span>
      <i class="fas fa-chevron-down" style="font-size:11px;"></i>
    </div>

    <!-- Panel de notificaciones -->
    <div id="notifPanel" style="display:none; position:absolute; right:60px; top:38px; background:#ffffff; border-radius:8px; box-shadow:0 12px 30px rgba(15,23,42,.18); min-width:260px; padding:12px 16px 14px 16px; z-index:25;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <span style="font-size:13px; font-weight:600; color:#111827;">NOTIFICACIONES</span>
        <span style="font-size:11px; font-weight:700; color:#ffffff; background:#ef4444; border-radius:999px; padding:2px 8px;">Nuevos 0</span>
      </div>
      <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">No tienes notificaciones nuevas.</div>
      <div style="text-align:center;">
        <a href="javascript:void(0);" style="font-size:12px; color:#0ea5a6; text-decoration:none; font-weight:600;">Ver más..</a>
      </div>
    </div>

    <div id="userMenu" style="display:none; position:absolute; right:0; top:38px; background:#ffffff; border-radius:8px; box-shadow:0 12px 30px rgba(15,23,42,.18); min-width:150px; padding:6px 0; z-index:20;">
      <a href="<?php echo BASE_URL; ?>personas/usuarios/Miperfil" style="display:flex; align-items:center; gap:8px; padding:8px 14px; font-size:13px; color:#374151; text-decoration:none;">
        <i class="fas fa-user-circle"></i>
        <span>Perfil</span>
      </a>
      <a href="<?php echo BASE_URL; ?>index/cerrar" style="display:flex; align-items:center; gap:8px; padding:8px 14px; font-size:13px; color:#b91c1c; text-decoration:none;">
        <i class="fas fa-sign-out-alt"></i>
        <span>Cerrar sesión</span>
      </a>
    </div>
  </div>
</div>

<script>
  (function(){
    var toggle      = document.getElementById('userMenuToggle');
    var menu        = document.getElementById('userMenu');
    var notifToggle = document.getElementById('notifToggle');
    var notifPanel  = document.getElementById('notifPanel');

    if (toggle && menu) {
      toggle.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        if (notifPanel) { notifPanel.style.display = 'none'; }
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
      });
    }

    if (notifToggle && notifPanel) {
      notifToggle.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        if (menu) { menu.style.display = 'none'; }
        notifPanel.style.display = (notifPanel.style.display === 'block') ? 'none' : 'block';
      });
    }

    document.addEventListener('click', function(e){
      if (menu && toggle && !toggle.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = 'none';
      }
      if (notifPanel && notifToggle && !notifToggle.contains(e.target) && !notifPanel.contains(e.target)) {
        notifPanel.style.display = 'none';
      }
    });

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') {
        if (menu) { menu.style.display = 'none'; }
        if (notifPanel) { notifPanel.style.display = 'none'; }
      }
    });
  })();
</script>